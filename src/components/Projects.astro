---
interface Project {
  title: string;
  category?: string;
  description?: string;
  image?: string;
  imageUrl?: string;
  slug?: string;
  link?: string;
  github?: string;
}

const { projects = [] } = Astro.props as { projects?: Project[] };

const getImageUrl = (project: Project) => {
  if (project.imageUrl) return project.imageUrl;
  if (project.image) return project.image;
  if (project.link) return `https://image.thum.io/get/width/1000/crop/800/${project.link}`;
  return null;
};

const getPrimaryLink = (project: Project) => {
  if (project.link) return project.link;
  if (project.github) return project.github;
  if (project.slug) return `/proiect/${project.slug}`;
  return null;
};

const isExternalLink = (url: string | null) => Boolean(url && /^https?:\/\//.test(url));
---

<section id="work" data-projects-carousel class="relative w-full bg-[#020617] py-24 overflow-hidden font-sans">
  <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

  <header class="text-center mb-16 px-6 relative z-20">
    <span class="text-[#38bdf8] text-xs font-bold tracking-[0.2em] uppercase mb-4 block">Portofoliu</span>
    <h2 class="text-4xl md:text-6xl font-black text-white mb-6 tracking-wide uppercase">Selected Works</h2>
    <p class="text-zinc-400 max-w-2xl mx-auto text-sm md:text-base leading-relaxed">
      Exploreaza cele mai recente produse digitale.
    </p>
  </header>

  <div class="relative w-full group">
    <button
      data-carousel-prev
      class="hidden md:flex absolute left-8 top-1/2 -translate-y-1/2 z-50 w-12 h-12 rounded-full bg-white/5 border border-white/10 text-white items-center justify-center text-2xl hover:bg-[#38bdf8] hover:text-black transition-all"
      aria-label="Proiectul anterior"
    >
      ‹
    </button>
    <button
      data-carousel-next
      class="hidden md:flex absolute right-8 top-1/2 -translate-y-1/2 z-50 w-12 h-12 rounded-full bg-white/5 border border-white/10 text-white items-center justify-center text-2xl hover:bg-[#38bdf8] hover:text-black transition-all"
      aria-label="Proiectul urmator"
    >
      ›
    </button>

    <div data-carousel-track class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth no-scrollbar py-12 px-[calc(50vw-140px)] md:px-[calc(50vw-240px)] gap-4">
      {projects.map((project, index) => {
        const href = getPrimaryLink(project);
        const external = isExternalLink(href);

        return (
          <div class="carousel-item flex-none w-[280px] md:w-[480px] snap-center transition-all duration-500 ease-out opacity-30 scale-90 blur-[1px]" data-index={index}>
            <article class="relative flex flex-col h-[480px] md:h-[520px] bg-[#0b1120] rounded-[1.5rem] overflow-hidden border border-white/5 shadow-2xl">
              {href && (
                <a
                  href={href}
                  target={external ? '_blank' : undefined}
                  rel={external ? 'noopener noreferrer' : undefined}
                  class="absolute inset-0 z-30"
                  aria-label={`Deschide ${project.title}`}
                ></a>
              )}

              <figure class="h-56 md:h-64 bg-slate-950 overflow-hidden">
                {getImageUrl(project) ? (
                  <img
                    src={getImageUrl(project)}
                    alt={project.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    loading="lazy"
                  />
                ) : (
                  <div class="h-full flex items-center justify-center text-zinc-600 text-xs font-bold uppercase">Fara previzualizare</div>
                )}
              </figure>

              <div class="p-6 md:p-8 flex flex-col flex-grow">
                <span class="text-[#38bdf8] text-[10px] md:text-xs font-bold tracking-widest uppercase mb-2">{project.category || 'General'}</span>
                <h3 class="text-xl md:text-2xl font-bold text-white mb-3">{project.title}</h3>
                <p class="text-zinc-400 text-xs md:text-sm line-clamp-3 leading-relaxed">{project.description || ''}</p>
              </div>
            </article>
          </div>
        );
      })}
    </div>
  </div>
</section>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  .carousel-item.is-active {
    opacity: 1 !important;
    transform: scale(1) !important;
    filter: blur(0);
    border-color: rgba(56, 189, 248, 0.2);
  }
</style>

<script>
const initCarousel = (root) => {
  if (!root || root.dataset.carouselInit === 'true') return;

  const track = root.querySelector('[data-carousel-track]');
  const prevBtn = root.querySelector('[data-carousel-prev]');
  const nextBtn = root.querySelector('[data-carousel-next]');
  if (!track) return;

  const items = Array.from(track.querySelectorAll('.carousel-item'));
  if (items.length === 0) return;

  root.dataset.carouselInit = 'true';
  let currentIndex = 0;
  let scrollRaf = null;

  const setActiveClass = (index) => {
    items.forEach((item, itemIndex) => item.classList.toggle('is-active', itemIndex === index));
  };

  const centerItem = (index, behavior = 'smooth') => {
    const clamped = (index + items.length) % items.length;
    const item = items[clamped];
    item.scrollIntoView({ behavior, block: 'nearest', inline: 'center' });
    currentIndex = clamped;
    setActiveClass(clamped);
  };

  const syncIndexFromScroll = () => {
    const trackCenter = track.scrollLeft + track.clientWidth / 2;
    let nearestIndex = 0;
    let nearestDistance = Infinity;

    items.forEach((item, index) => {
      const itemCenter = item.offsetLeft + item.clientWidth / 2;
      const distance = Math.abs(itemCenter - trackCenter);
      if (distance < nearestDistance) {
        nearestDistance = distance;
        nearestIndex = index;
      }
    });

    if (nearestIndex !== currentIndex) {
      currentIndex = nearestIndex;
      setActiveClass(currentIndex);
    }
  };

  track.addEventListener('scroll', () => {
    if (scrollRaf) cancelAnimationFrame(scrollRaf);
    scrollRaf = requestAnimationFrame(syncIndexFromScroll);
  }, { passive: true });

  nextBtn?.addEventListener('click', () => centerItem(currentIndex + 1));
  prevBtn?.addEventListener('click', () => centerItem(currentIndex - 1));
  window.addEventListener('resize', () => centerItem(currentIndex, 'auto'));

  centerItem(0, 'auto');
};

const setupCarousels = () => {
  document.querySelectorAll('[data-projects-carousel]').forEach((root) => initCarousel(root));
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupCarousels, { once: true });
} else {
  setupCarousels();
}
document.addEventListener('astro:after-swap', setupCarousels);
</script>
